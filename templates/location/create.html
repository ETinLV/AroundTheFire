{% extends 'base.html' %}
{% load bootstrap3 %}
{% load staticfiles %}
{% block title %}
    Home
{% endblock %}


{% block pane-one-title %}
    Share A New Campsite
{% endblock %}
{% block pane-one %}
    <h4>Campsite Details</h4>
    <form method="post" action="{% url 'location_create'  %}">
    {% csrf_token %}
    {% bootstrap_form form layout='inline'%}
    <input type="submit" value="Create A Campsite" class="btn btn-success">
    <input type="hidden" name="lat" value="{{ view.kwargs.lat }}">
    <input type="hidden" name="lng" value="{{ view.kwargs.lng }}">
    </form>
{% endblock %}


{% block pane-two-title %}
{% endblock %}

{% block pane-two %}
    <p>When creating a trip, please be as accurate as possible. try zooming in
    as far as your can!</p>
{% endblock %}

{% block pane-three-title %}

{% endblock %}

{% block pane-three %}
    <iframe id="forecast_embed" type="text/html" frameborder="0" height="245" width="100%" src="http://forecast.io/embed/#lat={{ camper.lat }}&lon={{ camper.lng }}&name={{ camper.zip }}"> </iframe>
{% endblock %}

{% block javascript %}
<script>
var iconBase = '{% static 'img/' %}';
var icons = {
  invited: {
    icon: iconBase + 'purplefire.png'
  },
  upcoming: {
    icon: iconBase + 'redfire.png'
  },
  past: {
    icon: iconBase + 'blackfire.png'
  },
  home: {
    icon: iconBase + 'home.png'
  },
  campsite: {
    icon: iconBase + 'campsite.png'
  }
};
var map;
function initMap() {
    var defautLat = Number({{ user.camper.lat }});
    var defautLng = Number({{ user.camper.lng }});
    var myLatLng2 = {lat: defautLat, lng: defautLng};
    var all;
    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 10,
        center: myLatLng2,
        mapTypeId: google.maps.MapTypeId.TERRAIN
    });
    placeMarker();
    //adds markers for each trip type
    //place a marker on the center of the map
    function placeMarker() {
        var marker = new google.maps.Marker({
            map: map,
            position: {
                lat: defautLat,
                lng: defautLng
            },
            icon: icons['home'].icon
        });
{#            var infowindow = new google.maps.InfoWindow({#}
{#                content: (invited[0].fields.name.link('location/'+invited[0].pk))#}
{##}
{#            });#}
{#            google.maps.event.addListener(marker, 'click', function () {#}
{#                infowindow.open(map, marker);#}
{#            });#}
    }
    function placeAllMarker(loc) {
        var marker = new google.maps.Marker({
            map: map,
            position: {
                lat: Number(all[loc].fields.lat),
                lng: Number(all[loc].fields.lng)
            },
            icon: icons['campsite'].icon
        });
        var infowindow = new google.maps.InfoWindow({
            content: (all[loc].fields.name.link('../location/'+all[loc].pk))

        });
        google.maps.event.addListener(marker, 'click', function () {
            infowindow.open(map, marker);
        });
    }

    google.maps.event.addListener(map, 'idle', function() {
        checkIfMarkersStillVisible();
    });
    function checkIfMarkersStillVisible() {
        coords =  map.getBounds();
        zoom = map.getZoom();
        coordsDict = {"n": coords.getNorthEast().lat().toString(),
            'e': coords.getNorthEast().lng().toString(),
            's': coords.getSouthWest().lat().toString(),
            'w': coords.getSouthWest().lng().toString(),
            'zoom': zoom.toString()};

        $.ajax({
            url: "{% url 'get_markers' %}",
            dataType: "json",
            data: coordsDict,
            success : function(locations) {
                //loop thought locations and call the marker place functions
                all = JSON.parse(locations);
                for (loc in all) {
                    placeAllMarker(loc);}
                },

            error : function(xhr,errmsg,err) {
                console.log(xhr.status + ": " + xhr.responseText)
            }
        });
    }
    var infowindownew = new google.maps.InfoWindow(
      {
        size: new google.maps.Size(150,50)
      });


    google.maps.event.addListener(map, 'click', function (event) {
        //call function to create marker
        if (marker) {
            marker.setMap(null);
            marker = null;
        }
        marker = createMarker(event.latLng, "name", "<b>Location</b><br>" + event.latLng);
    });
    // A function to create the marker and set up the event window function
    function createMarker(latlng, name, html) {
        var contentString = html.link('location/create/'+latlng);
        var marker = new google.maps.Marker({
            position: latlng,
            map: map,
            zIndex: Math.round(latlng.lat() * -100000) << 5
        });

        google.maps.event.addListener(marker, 'click', function () {
            infowindownew.setContent(contentString);
            infowindownew.open(map, marker);
        });
        google.maps.event.trigger(marker, 'click');
        return marker;
    }
}


</script>
{% endblock %}